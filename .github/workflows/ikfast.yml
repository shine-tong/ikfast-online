name: IKFast Generator

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Execution mode'
        required: true
        type: choice
        options:
          - info
          - generate
      base_link:
        description: 'Base link index'
        required: false
        type: string
      ee_link:
        description: 'End effector link index'
        required: false
        type: string
      iktype:
        description: 'IKFast solver type'
        required: false
        type: string
        default: 'transform6d'

concurrency:
  group: ikfast-generation
  cancel-in-progress: true

jobs:
  ikfast:
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0
      
      - name: Pull latest changes
        run: |
          git pull origin ${{ github.ref_name }}
      
      - name: Verify URDF file exists
        run: |
          if [ ! -f jobs/current/robot.urdf ]; then
            echo "ERROR: URDF file not found at jobs/current/robot.urdf"
            echo "Listing jobs/current directory:"
            ls -la jobs/current/ || echo "jobs/current directory does not exist"
            exit 1
          fi
          echo "URDF file found:"
          ls -lh jobs/current/robot.urdf
      
      - name: Validate inputs
        run: |
          if [ "${{ inputs.mode }}" = "generate" ]; then
            if [ -z "${{ inputs.base_link }}" ] || [ -z "${{ inputs.ee_link }}" ]; then
              echo "Error: base_link and ee_link are required for generate mode"
              exit 1
            fi
            if ! [[ "${{ inputs.base_link }}" =~ ^[0-9]+$ ]]; then
              echo "Error: base_link must be a non-negative integer"
              exit 1
            fi
            if ! [[ "${{ inputs.ee_link }}" =~ ^[0-9]+$ ]]; then
              echo "Error: ee_link must be a non-negative integer"
              exit 1
            fi
            if [ "${{ inputs.base_link }}" = "${{ inputs.ee_link }}" ]; then
              echo "Error: base_link and ee_link must be different"
              exit 1
            fi
          fi
      
      - name: Run IKFast in Docker (Info Mode)
        if: inputs.mode == 'info'
        run: |
          mkdir -p outputs
          
          # Create script file
          cat > run_info.sh << 'EOF'
          #!/bin/bash
          set -e
          source /opt/ros/noetic/setup.bash
          
          echo "=== STEP 1: URDF to Collada ==="
          rosrun collada_urdf urdf_to_collada jobs/current/robot.urdf robot.dae
          
          echo "=== STEP 2: Verify Collada File ==="
          ls -lh robot.dae
          
          echo "=== STEP 3: Extract Link Information ==="
          openrave-robot.py robot.dae --info links | tee outputs/links_raw.txt
          
          echo "=== INFO MODE COMPLETE ==="
          EOF
          
          chmod +x run_info.sh
          
          docker run --rm --platform linux/amd64 \
            -v ${GITHUB_WORKSPACE}:${GITHUB_WORKSPACE} \
            -w ${GITHUB_WORKSPACE} \
            fishros2/openrave \
            ./run_info.sh 2>&1 | tee outputs/info.log
          
          echo "Checking outputs directory:"
          ls -la outputs/
          
          if [ ! -f outputs/links_raw.txt ]; then
            echo "ERROR: links_raw.txt was not created"
            cat outputs/info.log
            exit 1
          fi
          
          echo "=== links_raw.txt content ==="
          cat outputs/links_raw.txt

      
      - name: Parse link info to JSON
        if: inputs.mode == 'info'
        run: |
          cat > parse_links.py << 'PYEOF'
          import json
          import re
          import sys
          
          try:
              with open('outputs/links_raw.txt', 'r') as f:
                  content = f.read()
          except FileNotFoundError:
              print("ERROR: outputs/links_raw.txt not found")
              sys.exit(1)
          
          print("Raw content length:", len(content))
          print("Raw content:")
          print(content)
          print("=" * 50)
          
          links = []
          in_link_section = False
          
          for line in content.split('\n'):
              line_stripped = line.strip()
              
              # Skip header lines
              if re.match(r'^name\s+index\s+parent', line_stripped, re.IGNORECASE):
                  in_link_section = True
                  continue
              
              # Skip separator lines
              if line_stripped.startswith('---') or line_stripped.startswith('==='):
                  if in_link_section and len(links) > 0:
                      break
                  continue
              
              # Parse data lines
              if in_link_section and line_stripped:
                  # Match: name (spaces) index (spaces) optional_parent
                  match = re.match(r'^(\S+)\s+(\d+)\s*(.*?)$', line_stripped)
                  if match:
                      name = match.group(1)
                      index = int(match.group(2))
                      parent_info = match.group(3).strip()
                      
                      # Extract parent name (it's just the parent name, no parentheses)
                      parent = parent_info if parent_info else None
                      
                      links.append({
                          'name': name,
                          'index': index,
                          'parent': parent
                      })
                      print(f"Parsed: {name} (index={index}, parent={parent})")
          
          if len(links) == 0:
              print("ERROR: No links were parsed")
              print("Debug: in_link_section =", in_link_section)
              sys.exit(1)
          
          with open('outputs/links.json', 'w') as f:
              json.dump({'links': links}, f, indent=2)
          
          print(f"\nSuccessfully parsed {len(links)} links")
          print(json.dumps({'links': links}, indent=2))
          PYEOF
          
          python3 parse_links.py
          
          if [ ! -f outputs/links.json ]; then
            echo "ERROR: links.json was not created"
            exit 1
          fi
          
          cat outputs/links.json
      
      - name: Run IKFast in Docker (Generate Mode)
        if: inputs.mode == 'generate'
        run: |
          mkdir -p outputs
          
          # Create script file
          cat > run_generate.sh << 'EOF'
          #!/bin/bash
          set -e
          source /opt/ros/noetic/setup.bash
          
          echo "=== STEP 1: URDF to Collada ==="
          rosrun collada_urdf urdf_to_collada jobs/current/robot.urdf robot.dae
          
          echo "=== STEP 2: Verify Collada File ==="
          ls -lh robot.dae
          
          echo "=== STEP 3: Generate IKFast Solver ==="
          python `openrave-config --python-dir`/openravepy/_openravepy_/ikfast.py \
            --robot=robot.dae \
            --iktype=${{ inputs.iktype }} \
            --baselink=${{ inputs.base_link }} \
            --eelink=${{ inputs.ee_link }} \
            --savefile=outputs/ikfast_solver.cpp
          
          echo "=== STEP 4: Verify Output ==="
          if [ -f outputs/ikfast_solver.cpp ]; then
            ls -lh outputs/ikfast_solver.cpp
            wc -l outputs/ikfast_solver.cpp
            sha256sum outputs/ikfast_solver.cpp
          else
            echo "ERROR: ikfast_solver.cpp was not generated"
            exit 1
          fi
          
          echo "=== GENERATION COMPLETE ==="
          EOF
          
          chmod +x run_generate.sh
          
          docker run --rm --platform linux/amd64 \
            -v ${GITHUB_WORKSPACE}:${GITHUB_WORKSPACE} \
            -w ${GITHUB_WORKSPACE} \
            fishros2/openrave \
            ./run_generate.sh 2>&1 | tee outputs/build.log
      
      - name: Verify output file integrity
        if: inputs.mode == 'generate'
        run: |
          if [ ! -f outputs/ikfast_solver.cpp ]; then
            echo "ERROR: ikfast_solver.cpp file is missing"
            exit 1
          fi
          
          if [ ! -s outputs/ikfast_solver.cpp ]; then
            echo "ERROR: ikfast_solver.cpp file is empty (0 bytes)"
            exit 1
          fi
          
          echo "Output file verification passed"
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ikfast-result
          path: outputs/
          retention-days: 7
