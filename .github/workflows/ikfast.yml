name: IKFast Generator

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Execution mode'
        required: true
        type: choice
        options:
          - info
          - generate
      base_link:
        description: 'Base link index'
        required: false
        type: string
      ee_link:
        description: 'End effector link index'
        required: false
        type: string
      iktype:
        description: 'IKFast solver type'
        required: false
        type: string
        default: 'transform6d'

concurrency:
  group: ikfast-generation
  cancel-in-progress: true  # Cancel old workflows when new one starts

jobs:
  ikfast:
    runs-on: ubuntu-latest  # Use latest Ubuntu (24.04)
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0
      
      - name: Pull latest changes
        run: |
          git pull origin ${{ github.ref_name }}
      
      - name: Verify URDF file exists
        run: |
          if [ ! -f jobs/current/robot.urdf ]; then
            echo "ERROR: URDF file not found at jobs/current/robot.urdf"
            echo "Listing jobs/current directory:"
            ls -la jobs/current/ || echo "jobs/current directory does not exist"
            exit 1
          fi
          echo "URDF file found:"
          ls -lh jobs/current/robot.urdf
      
      - name: Check system and Docker architecture
        run: |
          echo "=== System Information ==="
          uname -a
          echo ""
          echo "=== CPU Architecture ==="
          uname -m
          echo ""
          echo "=== Docker Version ==="
          docker --version
          echo ""
          echo "=== Docker Image Information ==="
          docker pull fishros2/openrave:latest
          docker image inspect fishros2/openrave:latest | grep -A 5 "Architecture"
          echo ""
          echo "=== Test Docker Execution ==="
          docker run --rm fishros2/openrave uname -a
          docker run --rm fishros2/openrave bash --version
      
      - name: Validate inputs
        run: |
          if [ "${{ inputs.mode }}" = "generate" ]; then
            if [ -z "${{ inputs.base_link }}" ] || [ -z "${{ inputs.ee_link }}" ]; then
              echo "Error: base_link and ee_link are required for generate mode"
              exit 1
            fi
            # Validate that base_link and ee_link are non-negative integers
            if ! [[ "${{ inputs.base_link }}" =~ ^[0-9]+$ ]]; then
              echo "Error: base_link must be a non-negative integer"
              exit 1
            fi
            if ! [[ "${{ inputs.ee_link }}" =~ ^[0-9]+$ ]]; then
              echo "Error: ee_link must be a non-negative integer"
              exit 1
            fi
            # Validate that base_link != ee_link
            if [ "${{ inputs.base_link }}" = "${{ inputs.ee_link }}" ]; then
              echo "Error: base_link and ee_link must be different"
              exit 1
            fi
          fi
      
      - name: Run IKFast in Docker (Info Mode)
        if: inputs.mode == 'info'
        run: |
          mkdir -p outputs
          
          # Run info mode to extract link information
          docker run --rm \
            --platform linux/amd64 \
            -v ${GITHUB_WORKSPACE}:/ws \
            -w /ws \
            fishros2/openrave \
            bash -c '
              set -e
              # Source ROS environment
              source /opt/ros/noetic/setup.bash
              
              echo "=== STEP 1: URDF to Collada ==="
              rosrun collada_urdf urdf_to_collada jobs/current/robot.urdf robot.dae
              
              echo "=== STEP 2: Verify Collada File ==="
              ls -lh robot.dae
              
              echo "=== STEP 3: Extract Link Information ==="
              openrave-robot.py robot.dae --info links | tee /ws/outputs/links_raw.txt
              
              echo "=== INFO MODE COMPLETE ==="
            ' 2>&1 | tee outputs/info.log
          
          # Verify outputs were created
          echo "Checking outputs directory:"
          ls -la outputs/
          
          if [ ! -f outputs/links_raw.txt ]; then
            echo "ERROR: links_raw.txt was not created"
            echo "=== Docker info.log content ==="
            cat outputs/info.log
            exit 1
          fi
          
          echo "=== links_raw.txt content ==="
          cat outputs/links_raw.txt
      
      - name: Parse link info to JSON
        if: inputs.mode == 'info'
        run: |
          echo "Parsing link information..."
          
          cat > parse_links.py << 'PYEOF'
          import json
          import re
          import sys
          
          # Read the raw link info
          try:
              with open('outputs/links_raw.txt', 'r') as f:
                  content = f.read()
          except FileNotFoundError:
              print("ERROR: outputs/links_raw.txt not found")
              sys.exit(1)
          
          print("Raw content length:", len(content))
          print("First 500 chars:", content[:500])
          
          links = []
          in_link_section = False
          header_found = False
          
          for line in content.split('\n'):
              line = line.strip()
              
              # Look for header line
              if re.match(r'^name\s+index\s+parent', line, re.IGNORECASE):
                  in_link_section = True
                  header_found = True
                  print("Found header line:", line)
                  continue
              
              # Parse link lines after header
              if in_link_section and header_found and line:
                  # Stop at separator or next section
                  if line.startswith('===') or line.startswith('---'):
                      break
                  
                  # Parse: "link_name index parent_info"
                  match = re.match(r'^(\S+)\s+(\d+)\s*(.*?)$', line)
                  if match:
                      name = match.group(1)
                      index = int(match.group(2))
                      parent_info = match.group(3).strip()
                      
                      # Extract parent name
                      parent = None
                      if parent_info:
                          parent_match = re.match(r'^(\S+)\(', parent_info)
                          if parent_match:
                              parent = parent_match.group(1)
                      
                      links.append({
                          'name': name,
                          'index': index,
                          'parent': parent
                      })
                      print(f"Parsed link: {name} (index {index}, parent: {parent})")
          
          if len(links) == 0:
              print("ERROR: No links were parsed")
              sys.exit(1)
          
          # Write JSON output
          with open('outputs/links.json', 'w') as f:
              json.dump({'links': links}, f, indent=2)
          
          print(f"\nSuccessfully parsed {len(links)} links")
          print(json.dumps({'links': links}, indent=2))
          PYEOF
          
          python3 parse_links.py
          
          # Verify JSON was created
          if [ ! -f outputs/links.json ]; then
            echo "ERROR: links.json was not created"
            exit 1
          fi
          
          echo "JSON file created successfully:"
          cat outputs/links.json

      
      - name: Run IKFast in Docker (Generate Mode)
        if: inputs.mode == 'generate'
        run: |
          mkdir -p outputs
          
          # Run full generation pipeline
          docker run --rm \
            --platform linux/amd64 \
            -v ${GITHUB_WORKSPACE}:/ws \
            -w /ws \
            fishros2/openrave \
            bash -c '
              set -e
              # Source ROS environment
              source /opt/ros/noetic/setup.bash
              
              echo "=== STEP 1: URDF to Collada ==="
              rosrun collada_urdf urdf_to_collada jobs/current/robot.urdf robot.dae
              
              echo "=== STEP 2: Verify Collada File ==="
              ls -lh robot.dae
              
              echo "=== STEP 3: Generate IKFast Solver ==="
              python `openrave-config --python-dir`/openravepy/_openravepy_/ikfast.py \
                --robot=robot.dae \
                --iktype=${{ inputs.iktype }} \
                --baselink=${{ inputs.base_link }} \
                --eelink=${{ inputs.ee_link }} \
                --savefile=/ws/outputs/ikfast_solver.cpp
              
              echo "=== STEP 4: Verify Output ==="
              if [ -f /ws/outputs/ikfast_solver.cpp ]; then
                ls -lh /ws/outputs/ikfast_solver.cpp
                wc -l /ws/outputs/ikfast_solver.cpp
                echo "=== STEP 5: Compute Checksum ==="
                sha256sum /ws/outputs/ikfast_solver.cpp
              else
                echo "ERROR: ikfast_solver.cpp was not generated"
                exit 1
              fi
              
              echo "=== GENERATION COMPLETE ==="
            ' 2>&1 | tee outputs/build.log
      
      - name: Verify output file integrity
        if: inputs.mode == 'generate'
        run: |
          if [ ! -f outputs/ikfast_solver.cpp ]; then
            echo "ERROR: ikfast_solver.cpp file is missing"
            exit 1
          fi
          
          if [ ! -s outputs/ikfast_solver.cpp ]; then
            echo "ERROR: ikfast_solver.cpp file is empty (0 bytes)"
            exit 1
          fi
          
          echo "Output file verification passed"
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ikfast-result
          path: outputs/
          retention-days: 7
