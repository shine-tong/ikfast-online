<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Info - IKFast Online</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #252526;
            border-radius: 5px;
        }
        h2 {
            color: #4ec9b0;
            margin-top: 0;
        }
        pre {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        .error {
            color: #f48771;
        }
        .success {
            color: #4ec9b0;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1177bb;
        }
    </style>
</head>
<body>
    <h1>IKFast Online - Debug Information</h1>
    
    <div class="section">
        <h2>1. 检查 JSZip 库</h2>
        <button onclick="checkJSZip()">检查 JSZip</button>
        <pre id="jszip-status"></pre>
    </div>
    
    <div class="section">
        <h2>2. 检查 CONFIG</h2>
        <button onclick="checkConfig()">检查 CONFIG</button>
        <pre id="config-status"></pre>
    </div>
    
    <div class="section">
        <h2>3. 测试 GitHub API 连接</h2>
        <input type="password" id="test-token" placeholder="输入 GitHub Token" style="width: 300px; padding: 5px;">
        <button onclick="testGitHubAPI()">测试 API</button>
        <pre id="api-status"></pre>
    </div>
    
    <div class="section">
        <h2>4. 检查最近的 Workflow Run</h2>
        <button onclick="checkWorkflowRuns()">检查 Workflow</button>
        <pre id="workflow-status"></pre>
    </div>
    
    <div class="section">
        <h2>5. 控制台日志</h2>
        <pre id="console-log"></pre>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="config.js"></script>
    
    <script>
        // Capture console logs
        const consoleLog = document.getElementById('console-log');
        const originalLog = console.log;
        const originalError = console.error;
        
        console.log = function(...args) {
            consoleLog.textContent += '[LOG] ' + args.join(' ') + '\n';
            originalLog.apply(console, args);
        };
        
        console.error = function(...args) {
            consoleLog.textContent += '[ERROR] ' + args.join(' ') + '\n';
            originalError.apply(console, args);
        };
        
        function checkJSZip() {
            const status = document.getElementById('jszip-status');
            if (typeof JSZip !== 'undefined') {
                status.innerHTML = '<span class="success">✓ JSZip 已加载</span>\n';
                status.innerHTML += 'JSZip 版本: ' + (JSZip.version || 'unknown');
            } else {
                status.innerHTML = '<span class="error">✗ JSZip 未加载</span>';
            }
        }
        
        function checkConfig() {
            const status = document.getElementById('config-status');
            if (typeof CONFIG !== 'undefined') {
                status.innerHTML = '<span class="success">✓ CONFIG 已加载</span>\n\n';
                status.innerHTML += JSON.stringify(CONFIG, null, 2);
            } else {
                status.innerHTML = '<span class="error">✗ CONFIG 未加载</span>';
            }
        }
        
        async function testGitHubAPI() {
            const status = document.getElementById('api-status');
            const token = document.getElementById('test-token').value;
            
            if (!token) {
                status.innerHTML = '<span class="error">请输入 GitHub Token</span>';
                return;
            }
            
            status.innerHTML = '测试中...\n';
            
            try {
                // Test basic API access
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    status.innerHTML = '<span class="success">✓ API 连接成功</span>\n';
                    status.innerHTML += `用户: ${data.login}\n`;
                    status.innerHTML += `权限: ${response.headers.get('x-oauth-scopes')}\n`;
                } else {
                    status.innerHTML = '<span class="error">✗ API 连接失败</span>\n';
                    status.innerHTML += `状态码: ${response.status}\n`;
                    const error = await response.json();
                    status.innerHTML += `错误: ${error.message}`;
                }
            } catch (error) {
                status.innerHTML = '<span class="error">✗ 网络错误</span>\n';
                status.innerHTML += error.message;
            }
        }
        
        async function checkWorkflowRuns() {
            const status = document.getElementById('workflow-status');
            const token = document.getElementById('test-token').value;
            
            if (!token) {
                status.innerHTML = '<span class="error">请先输入 GitHub Token</span>';
                return;
            }
            
            if (typeof CONFIG === 'undefined') {
                status.innerHTML = '<span class="error">CONFIG 未加载</span>';
                return;
            }
            
            status.innerHTML = '查询中...\n';
            
            try {
                const url = `https://api.github.com/repos/${CONFIG.REPO_OWNER}/${CONFIG.REPO_NAME}/actions/workflows/${CONFIG.WORKFLOW_FILE}/runs?per_page=5`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github+json',
                        'X-GitHub-Api-Version': '2022-11-28'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    status.innerHTML = '<span class="success">✓ 查询成功</span>\n\n';
                    
                    if (data.workflow_runs.length === 0) {
                        status.innerHTML += '没有找到 workflow runs\n';
                    } else {
                        data.workflow_runs.forEach((run, index) => {
                            status.innerHTML += `Run ${index + 1}:\n`;
                            status.innerHTML += `  ID: ${run.id}\n`;
                            status.innerHTML += `  状态: ${run.status}\n`;
                            status.innerHTML += `  结论: ${run.conclusion || 'N/A'}\n`;
                            status.innerHTML += `  创建时间: ${run.created_at}\n`;
                            status.innerHTML += `  链接: ${run.html_url}\n\n`;
                        });
                    }
                } else {
                    status.innerHTML = '<span class="error">✗ 查询失败</span>\n';
                    status.innerHTML += `状态码: ${response.status}\n`;
                    const error = await response.json();
                    status.innerHTML += `错误: ${error.message}`;
                }
            } catch (error) {
                status.innerHTML = '<span class="error">✗ 网络错误</span>\n';
                status.innerHTML += error.message;
            }
        }
        
        // Auto-check on load
        window.addEventListener('load', () => {
            checkJSZip();
            checkConfig();
        });
    </script>
</body>
</html>
